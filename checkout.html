<!DOCTYPE html>
<html>
<head>
<title>Checkout - One Bite</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  background:#000;
  color:#FFD700;
  text-align:center;
  font-family:sans-serif;
}

input,select{
  width:80%;
  padding:10px;
  margin:8px;
  border-radius:6px;
  border:none;
}

button{
  background:#FFD700;
  color:#000;
  padding:10px 20px;
  border:none;
  border-radius:6px;
  font-weight:bold;
}

.box{
  margin-top:10px;
}
</style>
</head>

<body>

<h2>Checkout - One Bite</h2>

<div class="box">
  Food Total: ₹<span id="foodTotal">0</span>
</div>

<div class="box">
  Delivery: ₹<span id="delivery">0</span>
</div>

<h3>Final Total: ₹<span id="finalTotal">0</span></h3>

<input id="name" placeholder="Name">
<input id="phone" placeholder="Phone">
<input id="address" placeholder="Address">

<select id="payment">
  <option value="COD">Cash On Delivery</option>
  <option value="POD">Pay Online (UPI)</option>
</select>

<br>
<button onclick="placeOrder()">Place Order</button>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getDatabase, ref, push } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyB63wz4Z8maGyYk7UdvZk2IvxwGXYePisA",
  authDomain: "onebiteapp-b19c3.firebaseapp.com",
  projectId: "onebiteapp-b19c3",
  storageBucket: "onebiteapp-b19c3.firebasestorage.app",
  messagingSenderId: "925416277184",
  appId: "1:925416277184:web:0af73016a42be902ea5925",
  databaseURL: "https://onebiteapp-b19c3-default-rtdb.asia-southeast1.firebasedatabase.app"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let foodTotal = parseInt(localStorage.getItem("total")) || 0;
document.getElementById("foodTotal").innerText = foodTotal;

function calculateDelivery(callback){

  navigator.geolocation.getCurrentPosition(
    function(position){

      const kitchenLat = 22.8665;
      const kitchenLng = 88.3672;

      const userLat = position.coords.latitude;
      const userLng = position.coords.longitude;

      const R = 6371;
      const dLat = (userLat - kitchenLat) * Math.PI/180;
      const dLng = (userLng - kitchenLng) * Math.PI/180;

      const a =
        Math.sin(dLat/2)*Math.sin(dLat/2) +
        Math.cos(kitchenLat*Math.PI/180) *
        Math.cos(userLat*Math.PI/180) *
        Math.sin(dLng/2)*Math.sin(dLng/2);

      const c = 2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
      const distance = R * c;

      let delivery = distance <= 2 ? 0 : 20;
      callback(delivery);

    },
    function(){
      callback(20);
    }
  );
}

window.placeOrder = function(){

  let name = document.getElementById("name").value;
  let phone = document.getElementById("phone").value;
  let address = document.getElementById("address").value;
  let payment = document.getElementById("payment").value;

  if(!name || !phone || !address){
    alert("Fill all fields");
    return;
  }

  calculateDelivery(function(delivery){

    document.getElementById("delivery").innerText = delivery;

    let finalAmount = foodTotal + delivery;
    document.getElementById("finalTotal").innerText = finalAmount;

    push(ref(db, "orders"), {
      name,
      phone,
      address,
      foodTotal,
      delivery,
      total: finalAmount,
      payment,
      status:"Pending",
      time:new Date().toLocaleString()
    });

    if(payment==="POD"){
      window.location.href=`upi://pay?pa=7003355253@ibl&pn=OneBite&am=${finalAmount}&cu=INR`;
    }

    alert("Order Placed Successfully!");

  });

};

</script>

</body>
</html>
